# endfield-trade-DP
基于动态规划(DP)的明日方舟：终末地弹性物资交易系统每日最优交易策略生成
# Endfield Trade DP

## 项目简介

**Endfield Trade DP** 是一个为游戏《明日方舟：终末地》中弹性物资交易系统设计的最优策略求解工具。它基于**动态规划**（Dynamic Programming）算法，通过分析每日随机价格和有限库存，计算出**阈值策略**，帮助玩家在给定周期内最大化交易利润。项目提供友好的 PyQt5 图形界面，支持参数调节、阈值表可视化、自动模拟测试以及实时决策辅助。

---

## 1. 开发背景与意义

在弹性物资交易中，玩家每天可以以某个价格买入商品，同时好友列表中会出现不同的卖出价格。通过低买高卖赚取差价，玩家可以在有限货架容量下进行交易。每天会补充固定数量的货架空间，但总容量有限。目标是在一段时间内最大化总利润。

问题可以被看做一个**随机动态规划**问题：为了防止组合爆炸和提升运行速度，可将操作简化为每天要么直接梭哈差价最大的商品，要么啥也不干屯可购买数量。因此，作者开发了一个在本条件下近似最优的策略来平衡风险与收益，且可通过数值方法高效计算。并提供了可视化操作页面。

---

## 2. 算法核心原理

### 2.1 问题形式化

- **周期天数** \( H \)（例如 7 天）
- **货架容量上限** \( C \)
- **每日补货量** \( R \)（每天开始时库存增加 \( R \)，但不超过 \( C \)）
- **初始库存** \( s_0 \)
- **商品种类数** \( n \)（例如 10 种）
- **好友数量** \( m \)（除自己外的好友数，总 \( m+1 \) 个报价者）

每天，每个商品 \( i \) 的买入价 \( p_i^{\text{self}} \) 和好友最高卖出价 \( p_i^{\text{best}} \) 从历史价格池中随机采样并添加噪声生成。定义差价：
\[
d_i = p_i^{\text{best}} - p_i^{\text{self}}, \quad z = \max_{i} d_i
\]
\( z \) 是当天可获得的最大单位利润。

当天开始时库存为 \( s \)，补货后可用库存：
\[
S = \min(C, s + R)
\]
玩家有两个动作：
- **不操作**：利润为 0，下一天开始库存为 \( S \)。
- **梭哈**：用全部 \( S \) 库存买入差价最大的商品并立即卖出，获得利润 \( z \cdot S \)，下一天开始库存为 0。

目标是最大化 \( H \) 天内的期望总利润。

### 2.2 动态规划递推

定义状态价值函数 \( V_t(s) \)：从第 \( t \) 天（\( t = 0,1,\dots,H-1 \)）开始，当天开始时库存为 \( s \) 时的最优期望总利润。终值条件：\( V_H(s) = 0 \)。

在第 \( t \) 天，给定 \( s \)，补货后库存 \( S \)。设下一期价值函数为 \( V_{t+1}(\cdot) \)。

若不操作，总收益为 \( V_{t+1}(S) \)；
若梭哈，总收益为 \( z \cdot S + V_{t+1}(0) \)。

最优决策取决于当天的随机变量 \( z \)。根据贝尔曼最优方程：
\[
V_t(s) = \mathbb{E}_z \left[ \max\left\{ V_{t+1}(S),\; z \cdot S + V_{t+1}(0) \right\} \right]
\]

令 \( \Delta = V_{t+1}(S) - V_{t+1}(0) \)（常数），则梭哈优于不操作当且仅当：
\[
z \cdot S \ge \Delta \quad \Leftrightarrow \quad z \ge \frac{\Delta}{S}
\]
因此最优策略是一个**阈值策略**：定义阈值
\[
\theta_t(S) = \frac{\Delta}{S}
\]
若观测到的 \( z \ge \theta_t(S) \)，则梭哈；否则不操作。

价值函数可分解为：
\[
V_t(s) = V_{t+1}(S) + \mathbb{E}_z \left[ \max\left( z \cdot S - \Delta,\; 0 \right) \right]
\]
期望项通过对 \( z \) 的分布采样近似。

### 2.3 \( z \) 分布的估计

\( z \) 的分布由价格生成机制决定。 `data.txt`中存放了作者手动收集的约1000个真实价格数据，代码从 `data.txt` 读取历史价格作为价格池，然后模拟 \( m+1 \) 个代理（自己 + \( m \) 个好友）对每个商品的报价（加均匀噪声），计算每组的最大差价 \( z \)，重复多次得到 \( z \) 的经验分布。

### 2.4 算法步骤

1. **采样 \( z \) 分布**：根据配置生成大量（如 20 万）\( z \) 样本。
2. **反向递推**：
   - 初始化 \( V_H(s) = 0 \)。
   - 对 \( t = H-1 \) 到 \( 0 \)：
     - 对每个可能库存 \( s \) 计算 \( S = \min(C, s + R) \)。
     - 计算 \( \Delta = V_{t+1}(S) - V_{t+1}(0) \)。
     - 阈值 \( \theta_t(S) = \Delta / S \)（若 \( S=0 \) 则设为无穷大）。
     - 用 \( z \) 样本计算期望增益，得到 \( V_t(s) \)。
3. 输出阈值矩阵 \( \theta[t, S] \) 和价值函数 \( V \)。

---

## 3. 测试结果

在四号谷地默认参数下（商品数 12，好友数 37，周期 7 天，货架容量 960，每日补货 320，初始库存 320，\( z \) 采样量 20 万，采样评估数 2 万），运行程序得到的典型结果如下（baseline定义为每天梭哈差价最大的商品）：

| 指标                         | 数值         |
|------------------------------|--------------|
| DP 策略平均利润               | 9,605,740.36  |
| Baseline平均利润              | 9,232,982.40  |
| DP 比 Baseline 平均多赚       | 372,757.96    |
| DP 利润增长率                 | 4.04%         |
在武陵默认参数下（商品数 4，好友数 37，周期 7 天，货架容量 100，每日补货 50，初始库存 50，\( z \) 采样量 20 万，采样评估数 2 万），运行程序得到的典型结果如下（baseline定义为每天梭哈差价最大的商品）：

| 指标                         | 数值         |
|------------------------------|--------------|
| DP 策略平均利润               | 1,373,302.23  |
| Baseline平均利润              | 1,335,351.66  |
| DP 比 Baseline 平均多赚       | 37,950.57     |
| DP 利润增长率                 | 2.84%         |

结果表明，DP 阈值策略在大多数情况下优于盲目梭哈，显著提升长期期望收益。

---

## 4. 使用方法

### 4.1 环境要求

- Python 3.7 或更高版本
- 依赖库：`numpy`, `matplotlib`, `PyQt5`

安装依赖：
```bash
pip install numpy matplotlib PyQt5
```

### 4.2 文件说明

- `dp.py`：核心算法模块（采样、DP 求解、模拟评估）
- `dp_gui.py`：PyQt5 图形界面（参数调节、阈值表展示、人工决策）
- `main_window.py`：程序入口，启动主窗口
- `data.txt`：历史价格数据文件


### 4.3 运行程序

在终端中执行：
```bash
python main_window.py
```

### 4.5 界面操作指南

程序包含两个标签页：

#### **DP策略调参与测试**
- **参数调节**：可设置商品列表、好友数、周期天数、货架容量、每日补货、初始库存、采样量、评估路径数、随机种子等。商品列表以英文逗号分隔。
- **生成DP表**：点击后执行采样和 DP 求解，自动运行一次模拟测试，绘制累计利润曲线，并展示每日决策详情（包括每天 \( z \)、阈值、动作、利润等）。
- **保存/导入DP表**：可将计算好的阈值矩阵保存为 `.dp` 文件，或导入已有文件，避免重复计算。
- **人工输入决策**：手动输入当前各商品的买入价和好友最高价，程序根据已有阈值表输出最优动作（梭哈/观望），并提示建议买卖的商品。

#### **开始交易！**
- 提供预设配置（四号谷地和武陵），可快速切换。
- 调节参数并求解 DP 表后，可在下方人工输入当前价格，获取实时决策建议。

---

## 5. 结尾

这是我第一次写github项目，请大家多多支持！

---
