# endfield-trade-DP
基于动态规划(DP)的明日方舟：终末地弹性物资交易系统每日最优交易策略生成
---

# Endfield Trade DP

**基于动态规划 (DP) 的《明日方舟：终末地》弹性物资交易系统最优策略生成工具**

---

## 📌 项目简介

**Endfield Trade DP** 是一个用于《明日方舟：终末地》弹性物资交易系统的最优策略求解工具。

本项目基于 **动态规划（Dynamic Programming, DP）** 构建阈值策略，通过分析：

* 每日随机价格
* 有限货架容量
* 补货机制

计算在给定周期内的**最优交易决策**，从而最大化长期期望利润。

项目提供：

* ✅ DP 自动求解
* ✅ 阈值策略表可视化
* ✅ 自动模拟测试
* ✅ PyQt5 图形界面实时决策辅助

---

# 1️⃣ 开发背景与意义

在弹性物资交易系统中：

* 每天可以以某个价格买入商品
* 好友列表会出现不同卖出报价
* 通过低买高卖赚取差价
* 货架容量有限
* 每日固定补货

目标是在有限周期内 **最大化总利润**。

---

## 🎯 简化后的决策模型

为了避免组合爆炸并提升计算效率，策略被简化为每天两种操作：

* **观望（不操作）**
* **梭哈（使用全部库存交易最大差价商品）**

在此假设下，可以构建一个近似最优的动态规划模型，并通过数值方法高效求解。

---

# 2️⃣ 算法核心原理

---

## 2.1 问题形式化

设：

* 周期天数：$H$
* 货架容量上限：$C$
* 每日补货量：$R$
* 初始库存：$s_0$
* 商品种类数：$n$
* 好友数量：$m$

---

### 每日价格生成

每天：

* 自己买入价：$p_i^{\text{self}}$
* 好友最高卖出价：$p_i^{\text{best}}$

定义差价：

$$
d_i = p_i^{\text{best}} - p_i^{\text{self}}
$$

当日最大单位利润：

$$
z = \max_i d_i
$$

---

### 库存变化

当天开始库存为 $s$：

$$
S = \min(C, s + R)
$$

---

### 可选动作

#### 1️⃣ 不操作

利润：0
下一天库存：$S$

#### 2️⃣ 梭哈

利润：

$$
z \cdot S
$$

下一天库存：0

---

目标：最大化 $H$ 天内的期望总利润。

---

## 2.2 动态规划递推

定义价值函数：

$$
V_t(s)
$$

表示第 $t$ 天开始、库存为 $s$ 时的最大期望收益。

终止条件：

$$
V_H(s) = 0
$$

---

### 贝尔曼最优方程

$$
V_t(s) =
\mathbb{E}*z \left[
\max\left{
V*{t+1}(S), ;
zS + V_{t+1}(0)
\right}
\right]
$$

---

设：

$$
\Delta = V_{t+1}(S) - V_{t+1}(0)
$$

梭哈优于观望当且仅当：

$$
zS \ge \Delta
$$

即：

$$
z \ge \frac{\Delta}{S}
$$

---

## ⭐ 阈值策略

定义阈值：

$$
\theta_t(S) = \frac{\Delta}{S}
$$

若：

$$
z \ge \theta_t(S)
$$

👉 梭哈
否则 👉 观望

因此最优策略为**阈值策略**。

---

### 价值函数分解

$$
V_t(s) =
V_{t+1}(S)
+
\mathbb{E}_z \left[
\max(zS - \Delta, 0)
\right]
$$

期望值通过对 $z$ 的经验分布采样计算。

---

# 2.3 $z$ 分布估计

* 从 `data.txt` 读取约 1000 条真实价格数据
* 从历史价格池中采样
* 添加均匀噪声
* 模拟 $m+1$ 个报价者
* 计算最大差价 $z$
* 重复采样（如 20 万次）得到经验分布

---

# 2.4 算法流程

1️⃣ 采样 $z$ 分布
2️⃣ 反向动态规划递推

* 初始化 $V_H(s)=0$
* 从 $t=H-1$ 递推到 0
* 计算阈值矩阵 $\theta[t,S]$

3️⃣ 输出：

* 阈值策略表
* 价值函数
* 模拟测试结果

---

# 3️⃣ 测试结果

---

## 📍 四号谷地参数

* 商品数：12
* 好友数：37
* 周期：7 天
* 容量：960
* 每日补货：320
* 初始库存：320
* $z$ 采样量：200,000
* 模拟路径数：20,000

| 指标            | 数值           |
| ------------- | ------------ |
| DP 平均利润       | 9,605,740.36 |
| Baseline 平均利润 | 9,232,982.40 |
| 多赚            | 372,757.96   |
| 收益提升          | **4.04%**    |

---

## 📍 武陵参数

* 商品数：4
* 好友数：37
* 周期：7 天
* 容量：100
* 每日补货：50
* 初始库存：50

| 指标            | 数值           |
| ------------- | ------------ |
| DP 平均利润       | 1,373,302.23 |
| Baseline 平均利润 | 1,335,351.66 |
| 多赚            | 37,950.57    |
| 收益提升          | **2.84%**    |

---

## ✅ 结论

DP 阈值策略在绝大多数情况下：

* 优于每天盲目梭哈
* 显著提升长期期望收益
* 风险控制更稳定

---

# 4️⃣ 使用方法

---

## 4.1 环境要求

* Python ≥ 3.7
* numpy
* matplotlib
* PyQt5

```bash
pip install numpy matplotlib PyQt5
```

---

## 4.2 文件结构

```
dp.py            # 核心算法
dp_gui.py        # GUI界面
main_window.py   # 程序入口
data.txt         # 历史价格数据
```

---

## 4.3 启动程序

```bash
python main_window.py
```

---

# 5️⃣ 界面说明

---

## 📊 DP 策略调参与测试

* 参数调节
* 生成 DP 表
* 自动模拟测试
* 阈值矩阵可视化
* 保存 / 导入 DP 表
* 人工输入当前价格 → 输出最优决策

---

## 🚀 开始交易!

* 预设配置（四号谷地 / 武陵）
* 快速求解
* 实时决策建议

---

# 🎉 结语

这是我第一次发布 GitHub 项目，欢迎大家：

* ⭐ Star
* 🐛 提 Issue
* 🔧 提 PR
* 💬 交流优化建议

---
